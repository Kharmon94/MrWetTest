<% content_for :title, "Question Bank - Sea Pass Pro" %>

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-1 text-primary">
            <i class="fas fa-question-circle me-2"></i>
            Question Bank
          </h1>
          <p class="text-muted mb-0">Manage questions for all your assessments</p>
        </div>
        <%= link_to new_instructor_question_path, class: "btn btn-primary" do %>
          <i class="fas fa-plus me-1"></i> Create New Question
        <% end %>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                Total Questions
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= Question.count %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-question-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                Tests with Questions
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800"><%= Test.joins(:questions).distinct.count %></div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                Average per Test
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <%= Test.joins(:questions).distinct.count > 0 ? (Question.count / Test.joins(:questions).distinct.count.to_f).round(1) : 0 %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-chart-bar fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                Current Page
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <%= @questions.current_page %> / <%= @questions.total_pages %>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-filter me-2"></i>
        Filter Questions
      </h6>
    </div>
    <div class="card-body">
      <%= form_with url: instructor_questions_path, method: :get, local: true, class: "row g-3" do |form| %>
        <div class="col-md-4">
          <%= form.label :test_id, "Test", class: "form-label" %>
          <%= form.select :test_id, 
              options_from_collection_for_select(@tests, :id, :title, @selected_test_id),
              { prompt: "All Tests" },
              { class: "form-select" } %>
        </div>
        <div class="col-md-6">
          <%= form.label :search, "Search Questions", class: "form-label" %>
          <%= form.text_field :search, value: @search_term, class: "form-control", placeholder: "Search question content or answers..." %>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <%= form.submit "Filter", class: "btn btn-primary me-2" %>
          <%= link_to instructor_questions_path, class: "btn btn-outline-secondary" do %>
            Clear
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Questions Table -->
  <div class="card shadow">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
      <h6 class="m-0 font-weight-bold text-primary">Questions</h6>
      <small class="text-muted">
        Showing <%= @questions.offset + 1 %>-<%= [@questions.offset + @questions.count, @questions.total_count].min %> 
        of <%= @questions.total_count %> questions
      </small>
    </div>
    <div class="card-body">
      <% if @questions.any? %>
        <div class="table-responsive">
          <table class="table table-bordered" width="100%" cellspacing="0">
            <thead>
              <tr>
                <th width="5%">#</th>
                <th width="45%">Question</th>
                <th width="25%">Correct Answer</th>
                <th width="15%">Test</th>
                <th width="10%">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @questions.each_with_index do |question, index| %>
                <tr>
                  <td>
                    <span class="badge bg-light text-dark">
                      <%= @questions.offset + index + 1 %>
                    </span>
                  </td>
                  <td>
                    <div class="question-content">
                      <%= truncate(question.content, length: 100) %>
                      <% if question.content.length > 100 %>
                        <button class="btn btn-link btn-sm p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#question-<%= question.id %>" aria-expanded="false">
                          <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="collapse mt-2" id="question-<%= question.id %>">
                          <div class="card card-body bg-light">
                            <%= question.content %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <div class="answer-content">
                      <%= truncate(question.correct_answer, length: 60) %>
                      <% if question.correct_answer.length > 60 %>
                        <button class="btn btn-link btn-sm p-0 ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#answer-<%= question.id %>" aria-expanded="false">
                          <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="collapse mt-2" id="answer-<%= question.id %>">
                          <div class="card card-body bg-light">
                            <%= question.correct_answer %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <div>
                      <div class="font-weight-bold"><%= question.test.title %></div>
                      <small class="text-muted">
                        <%= question.test.assessment_type.humanize %>
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <%= link_to instructor_question_path(question), class: "btn btn-outline-primary" do %>
                        <i class="fas fa-eye"></i>
                      <% end %>
                      <%= link_to edit_instructor_question_path(question), class: "btn btn-outline-secondary" do %>
                        <i class="fas fa-edit"></i>
                      <% end %>
                      <%= link_to instructor_question_path(question), 
                                  method: :delete, 
                                  class: "btn btn-outline-danger",
                                  data: { 
                                    confirm: "Are you sure you want to delete this question?",
                                    turbo_method: :delete 
                                  } do %>
                        <i class="fas fa-trash"></i>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if @questions.total_pages > 1 %>
          <div class="d-flex justify-content-center mt-4">
            <%= paginate @questions, theme: 'bootstrap5' %>
          </div>
        <% end %>
      <% else %>
        <div class="text-center py-5">
          <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">No questions found</h5>
          <p class="text-muted">
            <% if params[:test_id].present? || params[:search].present? %>
              Try adjusting your filters to see more results.
            <% else %>
              Create your first question to get started.
            <% end %>
          </p>
          <%= link_to new_instructor_question_path, class: "btn btn-primary" do %>
            <i class="fas fa-plus me-1"></i> Create Your First Question
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<style>
.border-left-primary {
  border-left: 0.25rem solid #4e73df !important;
}
.border-left-success {
  border-left: 0.25rem solid #1cc88a !important;
}
.border-left-info {
  border-left: 0.25rem solid #36b9cc !important;
}
.border-left-warning {
  border-left: 0.25rem solid #f6c23e !important;
}

.text-gray-800 {
  color: #5a5c69 !important;
}

.text-gray-300 {
  color: #dddfeb !important;
}

.font-weight-bold {
  font-weight: 700 !important;
}

.text-xs {
  font-size: 0.7rem;
}

.shadow {
  box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
}

.table th {
  background-color: #f8f9fc;
  border-color: #e3e6f0;
  color: #5a5c69;
  font-weight: 600;
}

.table td {
  border-color: #e3e6f0;
  vertical-align: middle;
}

.question-content, .answer-content {
  max-width: 100%;
  word-wrap: break-word;
}

.bg-light {
  background-color: #f8f9fc !important;
}
</style>
