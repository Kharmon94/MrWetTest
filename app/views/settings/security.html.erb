<div class="container py-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="text-gradient h2 mb-0">Security Settings</h1>
        <%= link_to "← Back to Settings", settings_root_path, class: "btn btn-outline-secondary" %>
      </div>

      <!-- Password Change Form -->
      <%= form_with model: @user, url: settings_security_path, method: :patch, local: true, class: "needs-validation", novalidate: true do |form| %>
        <div class="card mb-4" style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
          <div class="card-header" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);">
            <h5 class="mb-0" style="color: var(--text-primary);">
              <i class="fas fa-key me-2"></i>Change Password
            </h5>
          </div>
          <div class="card-body p-4">
            <div class="row g-3">
              <!-- Current Password -->
              <div class="col-12">
                <div class="mb-3">
                  <%= form.label :current_password, "Current Password", class: "form-label", style: "color: var(--text-primary);" %>
                  <%= form.password_field :current_password, 
                      class: "form-control #{'is-invalid' if @user.errors[:current_password].any?}",
                      style: "background: var(--bg-primary); border: 1px solid var(--border-primary); color: var(--text-primary);",
                      required: true,
                      autocomplete: "current-password" %>
                  <% if @user.errors[:current_password].any? %>
                    <div class="invalid-feedback">
                      <%= @user.errors[:current_password].first %>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- New Password -->
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :password, "New Password", class: "form-label", style: "color: var(--text-primary);" %>
                  <%= form.password_field :password, 
                      class: "form-control #{'is-invalid' if @user.errors[:password].any?}",
                      style: "background: var(--bg-primary); border: 1px solid var(--border-primary); color: var(--text-primary);",
                      required: true,
                      minlength: 6,
                      autocomplete: "new-password" %>
                  <% if @user.errors[:password].any? %>
                    <div class="invalid-feedback">
                      <%= @user.errors[:password].first %>
                    </div>
                  <% end %>
                  <small class="form-text" style="color: var(--text-muted);">Minimum 6 characters</small>
                </div>
              </div>

              <!-- Password Confirmation -->
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :password_confirmation, "Confirm New Password", class: "form-label", style: "color: var(--text-primary);" %>
                  <%= form.password_field :password_confirmation, 
                      class: "form-control #{'is-invalid' if @user.errors[:password_confirmation].any?}",
                      style: "background: var(--bg-primary); border: 1px solid var(--border-primary); color: var(--text-primary);",
                      required: true,
                      autocomplete: "new-password" %>
                  <% if @user.errors[:password_confirmation].any? %>
                    <div class="invalid-feedback">
                      <%= @user.errors[:password_confirmation].first %>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>

            <!-- Password Strength Indicator -->
            <div class="mb-3">
              <div class="d-flex align-items-center">
                <span class="me-2 small" style="color: var(--text-secondary);">Password Strength:</span>
                <div class="flex-grow-1">
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar" id="password-strength-bar" role="progressbar" style="width: 0%;"></div>
                  </div>
                </div>
                <span class="ms-2 small" id="password-strength-text" style="color: var(--text-secondary);">Weak</span>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-3 justify-content-end">
              <%= link_to "Cancel", settings_root_path, class: "btn btn-outline-secondary" %>
              <%= form.submit "Update Password", class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Security Information -->
      <div class="card mb-4" style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
        <div class="card-header" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);">
          <h5 class="mb-0" style="color: var(--text-primary);">
            <i class="fas fa-shield-alt me-2"></i>Security Information
          </h5>
        </div>
        <div class="card-body" style="color: var(--text-primary);">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div class="bg-success bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-check text-success"></i>
                  </div>
                </div>
                <div>
                  <h6 class="mb-1" style="color: var(--text-primary);">Account Status</h6>
                  <p class="mb-0 small" style="color: var(--text-secondary);">Active and secure</p>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div class="bg-info bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-clock text-info"></i>
                  </div>
                </div>
                <div>
                  <h6 class="mb-1" style="color: var(--text-primary);">Account Created</h6>
                  <p class="mb-0 small" style="color: var(--text-secondary);">
                    <%= time_ago_in_words(@user.created_at) + " ago" %>
                  </p>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div class="bg-warning bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-envelope text-warning"></i>
                  </div>
                </div>
                <div>
                  <h6 class="mb-1" style="color: var(--text-primary);">Email Status</h6>
                  <p class="mb-0 small" style="color: var(--text-secondary);">
                    <span class="badge bg-success">Active</span>
                  </p>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <div class="bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                    <i class="fas fa-key text-primary"></i>
                  </div>
                </div>
                <div>
                  <h6 class="mb-1" style="color: var(--text-primary);">Password Last Changed</h6>
                  <p class="mb-0 small" style="color: var(--text-secondary);">
                    <%= @user.updated_at.strftime("%B %d, %Y") %>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Two-Factor Authentication (Coming Soon) -->
      <div class="card mb-4" style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
        <div class="card-header" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);">
          <h5 class="mb-0" style="color: var(--text-primary);">
            <i class="fas fa-mobile-alt me-2"></i>Two-Factor Authentication
          </h5>
        </div>
        <div class="card-body" style="color: var(--text-primary);">
          <div class="alert alert-info" style="background: var(--bg-tertiary); border-color: var(--border-primary); color: var(--text-primary);">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Coming Soon:</strong> Two-factor authentication (2FA) will be available in a future update to provide additional security for your account.
          </div>
        </div>
      </div>

      <!-- Login History (Coming Soon) -->
      <div class="card" style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
        <div class="card-header" style="background: var(--bg-tertiary); border-bottom: 1px solid var(--border-primary);">
          <h5 class="mb-0" style="color: var(--text-primary);">
            <i class="fas fa-history me-2"></i>Login History
          </h5>
        </div>
        <div class="card-body" style="color: var(--text-primary);">
          <div class="alert alert-info" style="background: var(--bg-tertiary); border-color: var(--border-primary); color: var(--text-primary);">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Coming Soon:</strong> View your recent login history and active sessions for enhanced security monitoring.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Password strength indicator
document.addEventListener('DOMContentLoaded', function() {
  const passwordField = document.querySelector('input[name="user[password]"]');
  const strengthBar = document.getElementById('password-strength-bar');
  const strengthText = document.getElementById('password-strength-text');

  if (passwordField && strengthBar && strengthText) {
    passwordField.addEventListener('input', function() {
      const password = this.value;
      const strength = calculatePasswordStrength(password);
      
      strengthBar.style.width = strength.score + '%';
      strengthBar.className = 'progress-bar ' + strength.class;
      strengthText.textContent = strength.text;
      strengthText.className = 'ms-2 small ' + strength.textClass;
    });
  }

  function calculatePasswordStrength(password) {
    let score = 0;
    let feedback = [];

    // Length check
    if (password.length >= 8) score += 25;
    else feedback.push('at least 8 characters');

    // Uppercase check
    if (/[A-Z]/.test(password)) score += 25;
    else feedback.push('uppercase letter');

    // Lowercase check
    if (/[a-z]/.test(password)) score += 25;
    else feedback.push('lowercase letter');

    // Number check
    if (/\d/.test(password)) score += 25;
    else feedback.push('number');

    // Special character check
    if (/[^A-Za-z0-9]/.test(password)) score += 10;
    else feedback.push('special character');

    // Determine strength level
    if (score < 30) {
      return { score: score, class: 'bg-danger', text: 'Weak', textClass: 'text-danger' };
    } else if (score < 60) {
      return { score: score, class: 'bg-warning', text: 'Fair', textClass: 'text-warning' };
    } else if (score < 90) {
      return { score: score, class: 'bg-info', text: 'Good', textClass: 'text-info' };
    } else {
      return { score: score, class: 'bg-success', text: 'Strong', textClass: 'text-success' };
    }
  }
});
</script>
