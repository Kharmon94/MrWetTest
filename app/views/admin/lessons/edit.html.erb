<% content_for :title, "Admin - Edit #{@lesson.title}" %>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
              <li class="breadcrumb-item">
                <%= link_to "Admin", admin_root_path, class: "text-decoration-none" %>
              </li>
              <li class="breadcrumb-item">
                <%= link_to "Lessons", admin_lessons_path, class: "text-decoration-none" %>
              </li>
              <li class="breadcrumb-item">
                <%= link_to @lesson.title, admin_lesson_path(@lesson), class: "text-decoration-none" %>
              </li>
              <li class="breadcrumb-item active" aria-current="page">Edit</li>
            </ol>
          </nav>
          <h1 class="h2 mb-0">Edit Lesson</h1>
          <p class="text-muted mb-0">Update lesson information and content</p>
        </div>
        
        <div class="d-flex gap-2">
          <%= link_to admin_lesson_path(@lesson), class: "btn btn-outline-secondary" do %>
            <i class="fas fa-arrow-left me-2"></i>Back to Lesson
          <% end %>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>Lesson Information
              </h5>
            </div>
            <div class="card-body">
              <%= form_with model: [:admin, @lesson], local: true, class: "needs-validation", novalidate: true do |form| %>
                <% if @lesson.errors.any? %>
                  <div class="alert alert-danger">
                    <h6>Please fix the following errors:</h6>
                    <ul class="mb-0">
                      <% @lesson.errors.full_messages.each do |message| %>
                        <li><%= message %></li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>

                <div class="row">
                  <div class="col-md-8 mb-3">
                    <%= form.label :title, class: "form-label" do %>
                      Lesson Title <span class="text-danger">*</span>
                    <% end %>
                    <%= form.text_field :title, class: "form-control", required: true, 
                        placeholder: "Enter lesson title" %>
                    <div class="invalid-feedback">
                      Please provide a lesson title.
                    </div>
                  </div>
                  
                  <div class="col-md-4 mb-3">
                    <%= form.label :position, class: "form-label" do %>
                      Position
                    <% end %>
                    <%= form.number_field :position, class: "form-control", 
                        placeholder: "Lesson order" %>
                    <div class="form-text">
                      Order of this lesson in the course
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.label :course_id, class: "form-label" do %>
                    Course <span class="text-danger">*</span>
                  <% end %>
                  <%= form.select :course_id, 
                      options_from_collection_for_select(@courses, :id, :title, @lesson.course_id),
                      { prompt: "Select a course" }, 
                      { class: "form-select", required: true } %>
                  <div class="invalid-feedback">
                    Please select a course.
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.label :content, class: "form-label" do %>
                    Lesson Content <span class="text-danger">*</span>
                  <% end %>
                  <%= form.text_area :content, class: "form-control", rows: 15, required: true,
                      placeholder: "Enter the lesson content here. You can use basic HTML formatting." %>
                  <div class="invalid-feedback">
                    Please provide lesson content.
                  </div>
                  <div class="form-text">
                    You can use basic HTML formatting like &lt;strong&gt;, &lt;em&gt;, &lt;ul&gt;, &lt;ol&gt;, etc.
                  </div>
                </div>

                <div class="d-flex justify-content-between">
                  <%= link_to admin_lesson_path(@lesson), class: "btn btn-secondary" do %>
                    <i class="fas fa-times me-2"></i>Cancel
                  <% end %>
                  
                  <%= form.submit "Update Lesson", class: "btn btn-primary" do %>
                    <i class="fas fa-save me-2"></i>Update Lesson
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Lesson Stats -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>Lesson Statistics
              </h6>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <strong>Content Length:</strong><br>
                <span class="badge bg-info"><%= @lesson.content.length %> characters</span>
              </div>
              
              <div class="mb-3">
                <strong>Word Count:</strong><br>
                <span class="badge bg-success"><%= @lesson.content.split.length %> words</span>
              </div>
              
              <div class="mb-3">
                <strong>Estimated Read Time:</strong><br>
                <span class="badge bg-warning"><%= (@lesson.content.split.length / 200.0).ceil %> minutes</span>
              </div>
              
              <div class="mb-0">
                <strong>Associated Tests:</strong><br>
                <span class="badge bg-primary"><%= @lesson.tests.count %></span>
              </div>
            </div>
          </div>

          <!-- Preview Actions -->
          <div class="card mb-4">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-eye me-2"></i>Preview & Actions
              </h6>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <%= link_to course_lesson_path(@lesson.course, @lesson), 
                    class: "btn btn-info", target: "_blank" do %>
                  <i class="fas fa-external-link-alt me-2"></i>Preview as Student
                <% end %>
                
                <% if @lesson.tests.any? %>
                  <%= link_to admin_lesson_path(@lesson), class: "btn btn-success" do %>
                    <i class="fas fa-clipboard-check me-2"></i>View Associated Tests
                  <% end %>
                <% else %>
                  <%= link_to new_admin_test_path, class: "btn btn-primary" do %>
                    <i class="fas fa-plus me-2"></i>Add Test to Lesson
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Help Card -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="fas fa-lightbulb me-2"></i>Editing Tips
              </h6>
            </div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  Preview changes before saving
                </li>
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  Check position for proper ordering
                </li>
                <li class="mb-2">
                  <i class="fas fa-check text-success me-2"></i>
                  Maintain consistent formatting
                </li>
                <li class="mb-0">
                  <i class="fas fa-check text-success me-2"></i>
                  Consider adding tests if needed
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Bootstrap form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>
